name: Deploy .env to VPS

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy-env:
    name: Deploy .env config to VPS
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Deploy .env via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            set -e
            TMPENV=$(mktemp)
            cat > "$TMPENV" << 'ENVEOF'
            TELEGRAM_BOT_TOKEN=${{ secrets.TELEGRAM_BOT_TOKEN }}
            TELEGRAM_CHAT_ID=${{ secrets.TELEGRAM_CHAT_ID }}
            MAILERLITE_API_TOKEN=${{ secrets.MAILERLITE_API_TOKEN }}
            DIGISTORE24_API_KEY=${{ secrets.DIGISTORE24_API_KEY }}
            YOUTUBE_CLIENT_ID=${{ secrets.YOUTUBE_CLIENT_ID }}
            YOUTUBE_CLIENT_SECRET=${{ secrets.YOUTUBE_CLIENT_SECRET }}
            ETSY_API_KEY=${{ secrets.ETSY_API_KEY }}
            ETSY_SHARED_SECRET=${{ secrets.ETSY_SHARED_SECRET }}
            GUMROAD_APP_ID=${{ secrets.GUMROAD_APP_ID }}
            GUMROAD_APP_SECRET=${{ secrets.GUMROAD_APP_SECRET }}
            GUMROAD_ACCESS_TOKEN=${{ secrets.GUMROAD_ACCESS_TOKEN }}
            GUMROAD_SELLER_ID=${{ secrets.GUMROAD_SELLER_ID }}
            VPS_HOST=${{ secrets.VPS_HOST }}
            PINTEREST_ACCESS_TOKEN=${{ secrets.PINTEREST_ACCESS_TOKEN }}
            PINTEREST_APP_ID=${{ secrets.PINTEREST_APP_ID }}
            ENVEOF
            chmod 600 "$TMPENV"
            mkdir -p /opt/fixfirst-autopost
            mv "$TMPENV" /opt/fixfirst-autopost/.env

            # === PHASE 1: STOP EVERYTHING ===
            echo "Phase 1: Stopping all services..."
            sudo systemctl stop fixfirst-autopost 2>/dev/null || true
            sudo systemctl reset-failed fixfirst-autopost 2>/dev/null || true
            pm2 stop all 2>/dev/null || true
            pm2 delete all 2>/dev/null || true
            sleep 2

            # === PHASE 2: KILL ALL PROCESSES ON PORTS ===
            echo "Phase 2: Killing processes on ports 3006 and 3001..."
            for PORT in 3006 3001; do
              PIDS=$(lsof -ti :$PORT 2>/dev/null || true)
              if [ -n "$PIDS" ]; then
                echo "Killing PIDs on port $PORT: $PIDS"
                echo "$PIDS" | xargs kill -9 2>/dev/null || true
              fi
            done
            sleep 3

            # Verify ports are free
            for PORT in 3006 3001; do
              if lsof -ti :$PORT >/dev/null 2>&1; then
                echo "ERROR: Port $PORT still in use after kill!"
                lsof -i :$PORT
                exit 1
              fi
            done
            echo "Ports 3006 and 3001 are free."

            # === PHASE 3: GIT CLONE OR PULL ===
            echo "Phase 3: Updating code..."
            if [ ! -d /opt/fixfirst-autopost/.git ]; then
              git clone https://github.com/fixfirstnl/fixfirst-autopost.git /tmp/fixfirst-autopost-repo
              cp -r /tmp/fixfirst-autopost-repo/* /opt/fixfirst-autopost/
              cp -r /tmp/fixfirst-autopost-repo/.git /opt/fixfirst-autopost/
              rm -rf /tmp/fixfirst-autopost-repo
            else
              cd /opt/fixfirst-autopost && git pull origin main
            fi

            # === PHASE 4: INSTALL DEPENDENCIES ===
            echo "Phase 4: Installing dependencies..."
            cd /opt/fixfirst-autopost
            npm install --production
            cd /opt/fixfirst-autopost/claw-autonomy-bridge
            npm install --production

            # Copy .env to claw-autonomy-bridge
            cp /opt/fixfirst-autopost/.env /opt/fixfirst-autopost/claw-autonomy-bridge/.env

            # === PHASE 5: FINAL PORT CHECK AND START ===
            echo "Phase 5: Final port check and service start..."
            for PORT in 3006 3001; do
              PIDS=$(lsof -ti :$PORT 2>/dev/null || true)
              if [ -n "$PIDS" ]; then
                echo "$PIDS" | xargs kill -9 2>/dev/null || true
              fi
            done
            sleep 2

            # Update and start systemd service
            if [ -f /opt/fixfirst-autopost/systemd/fixfirst-autopost.service ]; then
              sudo cp /opt/fixfirst-autopost/systemd/fixfirst-autopost.service /etc/systemd/system/
            fi
            sudo systemctl daemon-reload
            sudo systemctl enable fixfirst-autopost
            sudo systemctl start fixfirst-autopost

            # Wait and verify
            echo "Waiting for service to start..."
            sleep 8
            sudo systemctl is-active --quiet fixfirst-autopost || { echo 'Service failed to start'; sudo journalctl -u fixfirst-autopost -n 50 --no-pager; exit 1; }

            # Test health endpoint
            HEALTH=$(curl -s http://localhost:3006/api/health || echo 'HEALTH_CHECK_FAILED')
            echo "Health check: $HEALTH"
            echo "Service is running successfully"

      - name: Notify Telegram on success
        if: success()
        run: |
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -d chat_id="${{ secrets.TELEGRAM_CHAT_ID }}" \
            -d text="✅ *Claw Autonomy Bridge deployed successfully*%0APort: 3006%0ACommit: ${{ github.sha }}%0ABy: ${{ github.actor }}" \
            -d parse_mode="Markdown"

      - name: Notify Telegram on failure
        if: failure()
        run: |
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -d chat_id="${{ secrets.TELEGRAM_CHAT_ID }}" \
            -d text="❌ *Claw Autonomy Bridge deployment FAILED*%0ACommit: ${{ github.sha }}%0ABy: ${{ github.actor }}" \
            -d parse_mode="Markdown"
